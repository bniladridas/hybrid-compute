---
name: CI Sync

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        cpp: ["20"]
        cuda: ["12.4", "12.6"]
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install CUDA ${{ matrix.cuda }}
        uses: ./.github/actions/install-cuda
        with:
          cuda-version: ${{ matrix.cuda }}
          cuda-architectures: "75,80,86"
          install-dependencies: true

      - name: Install dependencies
        run: |
          # Add OpenCV repository for Ubuntu 22.04
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            software-properties-common \
            wget

          # Install OpenCV and development packages
          sudo apt-get install -y --no-install-recommends \
            libopencv-dev \
            libopencv-core-dev \
            libopencv-highgui-dev \
            libopencv-imgproc-dev \
            libopencv-imgcodecs-dev \
            libopencv-videoio-dev \
            libopencv-calib3d-dev \
            libopencv-features2d-dev \
            python3-opencv \
            pkg-config \
            cmake \
            build-essential

          # Add larger swap space to prevent OOM
          echo "Setting up swap space..."
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "Swap status:"
          swapon --show
          free -h

      - name: Install OpenCV dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libtbb-dev \
            build-essential \
            cmake \
            git \
            libgtk2.0-dev \
            pkg-config \
            libavcodec-dev \
            libavformat-dev \
            libswscale-dev \
            libjpeg-dev \
            libpng-dev \
            libtiff-dev \
            libdc1394-dev

      - name: Build OpenCV from source
        uses: ./.github/actions/build-opencv

      - name: Run custom dependency script
        run: |
          chmod +x scripts/ci/install_dependencies.sh
          export USE_CUDA=1
          export CI=true
          sudo -E ./scripts/ci/install_dependencies.sh

      - name: Configure CMake
        run: |
          BUILD_DIR="build-${{ matrix.cuda }}-${{ matrix.python-version }}"
          mkdir -p $BUILD_DIR
          cd $BUILD_DIR

          # Configure with CUDA and OpenCV support
          echo "Configuring with OpenCV_DIR: ${OpenCV_DIR:-Not found}"
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_CUDA=ON \
            -DCMAKE_CXX_STANDARD=${{ matrix.cpp }} \
            -DCMAKE_CXX_STANDARD_REQUIRED=ON \
            -DBUILD_TESTS=ON \
            -DOpenCV_DIR="${OpenCV_DIR:-/usr/local/lib/cmake/opencv4}"

          # Verify CUDA configuration
          echo "CUDA configuration:"
          cmake -LA . | grep -i cuda

      - name: Build
        run: |
          BUILD_DIR="build-${{ matrix.cuda }}-${{ matrix.python-version }}"
          cd $BUILD_DIR
          make -j$(nproc)

      - name: Run tests
        run: |
          BUILD_DIR="build-${{ matrix.cuda }}-${{ matrix.python-version }}"
          cd $BUILD_DIR
          ctest --output-on-failure

  codeql-analysis:
    needs: build-and-test
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for CodeQL

      - name: Install OpenCV dependencies
        run: |
          # Add OpenCV repository for Ubuntu 22.04
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            software-properties-common \
            wget

          # Install OpenCV and development packages
          sudo apt-get install -y --no-install-recommends \
            libopencv-dev \
            libopencv-core-dev \
            libopencv-highgui-dev \
            libopencv-imgproc-dev \
            libopencv-imgcodecs-dev \
            libopencv-videoio-dev \
            libopencv-calib3d-dev \
            libopencv-features2d-dev \
            python3-opencv \
            pkg-config \
            cmake \
            build-essential

          # Set OpenCV directory
          if [ -d "/usr/lib/x86_64-linux-gnu/cmake/opencv4" ]; then
            echo "Found OpenCV in /usr/lib/x86_64-linux-gnu/cmake/opencv4"
            echo "OpenCV_DIR=/usr/lib/x86_64-linux-gnu/cmake/opencv4" >> $GITHUB_ENV
          elif [ -d "/usr/local/lib/cmake/opencv4" ]; then
            echo "Found OpenCV in /usr/local/lib/cmake/opencv4"
            echo "OpenCV_DIR=/usr/local/lib/cmake/opencv4" >> $GITHUB_ENV
          else
            echo "ERROR: OpenCV not found in standard locations"
            exit 1
          fi

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: cpp
          config-file: .github/codeql/codeql-config.yml

      - name: Build with CodeQL
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_CUDA=OFF \
            -DBUILD_TESTS=OFF \
            -DCMAKE_CXX_STANDARD=${{ matrix.cpp }} \
            -DCMAKE_CXX_STANDARD_REQUIRED=ON \
            -DOpenCV_DIR="${OpenCV_DIR}" \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

          # Build with CodeQL
          cmake --build . --config Release
