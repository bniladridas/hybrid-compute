---
name: CI Sync

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      # Limit parallel compilation to avoid memory issues
      CMAKE_BUILD_PARALLEL_LEVEL: 2
      CTEST_PARALLEL_LEVEL: 2
      MAKEFLAGS: "-j2"
    strategy:
      matrix:
        cpp: ["20"]
        cuda: ["12.4", "12.6"]
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install CUDA ${{ matrix.cuda }}
        uses: ./.github/actions/install-cuda
        with:
          cuda-version: ${{ matrix.cuda }}
          cuda-architectures: "75,80,86"
          install-dependencies: true

      - name: Install dependencies
        run: |
          # Add OpenCV repository for Ubuntu 22.04
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            software-properties-common \
            wget

          # Install OpenCV and development packages
          sudo apt-get install -y --no-install-recommends \
            libopencv-dev \
            libopencv-core-dev \
            libopencv-highgui-dev \
            libopencv-imgproc-dev \
            libopencv-imgcodecs-dev \
            libopencv-videoio-dev \
            libopencv-calib3d-dev \
            libopencv-features2d-dev \
            python3-opencv \
            pkg-config \
            cmake \
            build-essential

          # Add moderate swap space to prevent OOM
          echo "Setting up swap space..."
          if [ ! -f /swapfile ]; then
            if sudo fallocate -l 2G /swapfile 2>/dev/null; then
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
              echo "Swap file created successfully"
            else
              echo "Failed to create swap file with fallocate, trying dd..."
              if sudo dd if=/dev/zero of=/swapfile bs=1M count=2048 2>/dev/null; then
                sudo chmod 600 /swapfile
                sudo mkswap /swapfile
                sudo swapon /swapfile
                echo "Swap file created with dd"
              else
                echo "Failed to create swap file, continuing without additional swap"
              fi
            fi
          else
            echo "Swap file already exists"
          fi
          echo "Swap status:"
          swapon --show
          free -h

      - name: Set up OpenCV environment
        run: |
          # Set OpenCV directory for CMake
          if [ -d "/usr/lib/x86_64-linux-gnu/cmake/opencv4" ]; then
            echo "Found OpenCV in /usr/lib/x86_64-linux-gnu/cmake/opencv4"
            echo "OpenCV_DIR=/usr/lib/x86_64-linux-gnu/cmake/opencv4" >> $GITHUB_ENV
          elif [ -d "/usr/local/lib/cmake/opencv4" ]; then
            echo "Found OpenCV in /usr/local/lib/cmake/opencv4"
            echo "OpenCV_DIR=/usr/local/lib/cmake/opencv4" >> $GITHUB_ENV
          else
            echo "Using system OpenCV packages"
            echo "OpenCV_DIR=" >> $GITHUB_ENV
          fi

          # Verify OpenCV installation
          pkg-config --exists opencv4 && \
            echo "OpenCV4 found" || echo "OpenCV4 not found"
          pkg-config --exists opencv && \
            echo "OpenCV found" || echo "OpenCV not found"

      - name: Configure CMake
        run: |
          BUILD_DIR="build-${{ matrix.cuda }}-${{ matrix.python-version }}"
          rm -rf $BUILD_DIR
          mkdir -p $BUILD_DIR
          cd $BUILD_DIR

          # Configure with CUDA and OpenCV support
          echo "Configuring with OpenCV_DIR: ${OpenCV_DIR:-System packages}"
          CMAKE_ARGS="-DCMAKE_BUILD_TYPE=Release -DUSE_CUDA=ON"
          CMAKE_ARGS="$CMAKE_ARGS -DCMAKE_CXX_STANDARD=${{ matrix.cpp }}"
          CMAKE_ARGS="$CMAKE_ARGS -DCMAKE_CXX_STANDARD_REQUIRED=ON"
          CMAKE_ARGS="$CMAKE_ARGS -DBUILD_TESTS=ON"

          # Add OpenCV_DIR if set
          if [ -n "${OpenCV_DIR}" ]; then
            CMAKE_ARGS="$CMAKE_ARGS -DOpenCV_DIR=${OpenCV_DIR}"
          fi

          echo "CMake arguments: $CMAKE_ARGS"
          cmake .. $CMAKE_ARGS

          # Verify CUDA configuration
          echo "CUDA configuration:"
          cmake -LA . | grep -i cuda

      - name: Build
        run: |
          BUILD_DIR="build-${{ matrix.cuda }}-${{ matrix.python-version }}"
          cd $BUILD_DIR
          echo "Memory usage before build:"
          free -h
          # Use limited parallelism to avoid memory issues
          make -j2
          echo "Memory usage after build:"
          free -h

      - name: Run tests
        run: |
          BUILD_DIR="build-${{ matrix.cuda }}-${{ matrix.python-version }}"
          cd $BUILD_DIR
          # Use limited parallelism for tests to avoid memory issues
          ctest --output-on-failure --parallel 2

  codeql-analysis:
    needs: build-and-test
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for CodeQL

      - name: Install OpenCV dependencies
        run: |
          # Add OpenCV repository for Ubuntu 22.04
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            software-properties-common \
            wget

          # Install OpenCV and development packages
          sudo apt-get install -y --no-install-recommends \
            libopencv-dev \
            libopencv-core-dev \
            libopencv-highgui-dev \
            libopencv-imgproc-dev \
            libopencv-imgcodecs-dev \
            libopencv-videoio-dev \
            libopencv-calib3d-dev \
            libopencv-features2d-dev \
            python3-opencv \
            pkg-config \
            cmake \
            build-essential

          # Set OpenCV directory
          if [ -d "/usr/lib/x86_64-linux-gnu/cmake/opencv4" ]; then
            echo "Found OpenCV in /usr/lib/x86_64-linux-gnu/cmake/opencv4"
            echo "OpenCV_DIR=/usr/lib/x86_64-linux-gnu/cmake/opencv4" >> $GITHUB_ENV
          elif [ -d "/usr/local/lib/cmake/opencv4" ]; then
            echo "Found OpenCV in /usr/local/lib/cmake/opencv4"
            echo "OpenCV_DIR=/usr/local/lib/cmake/opencv4" >> $GITHUB_ENV
          else
            echo "ERROR: OpenCV not found in standard locations"
            exit 1
          fi

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: cpp
          config-file: .github/codeql/codeql-config.yml

      - name: Build with CodeQL
        run: |
          rm -rf build
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_CUDA=OFF \
            -DBUILD_TESTS=OFF \
            -DCMAKE_CXX_STANDARD=20 \
            -DCMAKE_CXX_STANDARD_REQUIRED=ON \
            -DOpenCV_DIR="${OpenCV_DIR}" \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

          # Build with CodeQL using limited parallelism
          cmake --build . --config Release -- -j2
