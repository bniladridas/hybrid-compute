---
name: CI Sync

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        cuda: ["12.3"]
        python-version: ["3.12"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          chmod +x scripts/ci/install_dependencies.sh
          export USE_CUDA=1
          export CI=true
          # Use sudo to run the installation
          sudo -E ./scripts/ci/install_dependencies.sh

      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          # Set CUDA architecture if needed (example: for RTX 30xx cards)
          export CUDA_ARCHITECTURES="80"  # Ampere architecture
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_CUDA=ON \
            -DCUDA_TOOLKIT_ROOT_DIR=/usr/local/cuda-12.3 \
            -DCMAKE_CUDA_ARCHITECTURES=${CUDA_ARCHITECTURES:-} \
            -DBUILD_TESTS=ON

      - name: Build
        run: |
          cd build
          make -j$(nproc)

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure

  codeql-analysis:
    needs: build-and-test
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for CodeQL

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: cpp
          config-file: .github/codeql/codeql-config.yml

      - name: Build with CodeQL
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_CUDA=OFF -DBUILD_TESTS=OFF
          make -j$(nproc)

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:cpp"

  lint:
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Run pre-commit
        run: pre-commit run --all-files
