---
name: CI Sync

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        cuda: ["13.0"]
        python-version: ["3.12"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install CUDA ${{ matrix.cuda }}
        run: |
          # Add NVIDIA repository
          CUDA_REPO="https://developer.download.nvidia.com/compute/cuda"
          wget "${CUDA_REPO}/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb"
          sudo dpkg -i cuda-keyring_1.1-1_all.deb
          sudo apt-get update

          # Install CUDA 13.0
          sudo apt-get install -y --no-install-recommends \
            cuda-toolkit-13-0 \
            cuda-libraries-13-0 \
            cuda-nvtx-13-0 \
            libcufft-13-0 \
            libcurand-13-0 \
            libcublas-13-0 \
            libcudnn9 \
            libcudnn9-dev

          # Set up environment variables
          echo "CUDA_HOME=/usr/local/cuda-13.0" >> $GITHUB_ENV
          echo "PATH=/usr/local/cuda-13.0/bin:$PATH" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=/usr/local/cuda-13.0/lib64:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          # Add OpenCV repository for Ubuntu 22.04
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            software-properties-common \
            wget

          # Install OpenCV and development packages
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libopencv-dev \
            libopencv-core-dev \
            libopencv-highgui-dev \
            libopencv-imgproc-dev \
            libopencv-imgcodecs-dev \
            libopencv-videoio-dev \
            libopencv-calib3d-dev \
            libopencv-features2d-dev \
            python3-opencv \
            pkg-config \
            cmake \
            build-essential

          # Verify OpenCV installation
          echo "Verifying OpenCV installation..."
          if pkg-config --exists opencv4; then
            echo "OpenCV found via pkg-config"
            OPENCV_DIR=$(pkg-config --variable=libdir opencv4)/cmake/opencv4
            echo "OpenCV_DIR=$OPENCV_DIR" >> $GITHUB_ENV
            echo "OpenCV version: $(pkg-config --modversion opencv4)"
          else
            echo "WARNING: OpenCV not found via pkg-config, trying alternative methods..."
            # Try common OpenCV config locations
            for dir in \
              "/usr/local/lib/cmake/opencv4" \
              "/usr/lib/x86_64-linux-gnu/cmake/opencv4" \
              "/opt/opencv/build" \
              "/opt/opencv4/build"; do
              if [ -f "$dir/OpenCVConfig.cmake" ]; then
                echo "Found OpenCV in $dir"
                echo "OpenCV_DIR=$dir" >> $GITHUB_ENV
                export OpenCV_DIR="$dir"
                break
              fi
            done
          fi

          # Run the custom dependency installation script
          chmod +x scripts/ci/install_dependencies.sh
          export USE_CUDA=1
          export CI=true
          # Use sudo to run the installation
          sudo -E ./scripts/ci/install_dependencies.sh

      - name: Configure CMake
        run: |
          mkdir -p build
          cd build

          # Set up environment variables for CUDA
          export CUDA_HOME=/usr/local/cuda-13.0
          export PATH="${CUDA_HOME}/bin:${PATH}"
          export LD_LIBRARY_PATH="${CUDA_HOME}/lib64:${LD_LIBRARY_PATH:-}"

          # Set CUDA architecture (Ampere/RTX 30xx by default)
          export CUDA_ARCHITECTURES="80"

          # Configure with CUDA and OpenCV support
          echo "Configuring with OpenCV_DIR: ${OpenCV_DIR:-Not found}"
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_CUDA=ON \
            -DCUDA_TOOLKIT_ROOT_DIR="${CUDA_HOME}" \
            -DCUDA_TOOLKIT_ROOT="${CUDA_HOME}" \
            -DCMAKE_CUDA_ARCHITECTURES=${CUDA_ARCHITECTURES} \
            -DBUILD_TESTS=ON \
            -DOpenCV_DIR="${OpenCV_DIR:-/usr/lib/x86_64-linux-gnu/cmake/opencv4}"

          # Verify CUDA configuration
          echo "CUDA configuration:"
          cmake -LA . | grep -i cuda

      - name: Build
        run: |
          cd build
          make -j$(nproc)

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure

  codeql-analysis:
    needs: build-and-test
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for CodeQL

      - name: Install OpenCV dependencies
        run: |
          # Add OpenCV repository for Ubuntu 22.04
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            software-properties-common \
            wget

          # Add OpenCV repository
          sudo add-apt-repository -y ppa:deadsnakes/ppa

          # Install OpenCV and development packages
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libopencv-dev \
            libopencv-core-dev \
            libopencv-highgui-dev \
            libopencv-imgproc-dev \
            libopencv-imgcodecs-dev \
            libopencv-videoio-dev \
            libopencv-calib3d-dev \
            libopencv-features2d-dev \
            python3-opencv \
            pkg-config \
            cmake \
            build-essential

          # Verify OpenCV installation and set environment variables
          echo "Verifying OpenCV installation..."
          if pkg-config --exists opencv4; then
            echo "OpenCV found via pkg-config"
            OPENCV_DIR=$(pkg-config --variable=libdir opencv4)/cmake/opencv4
            echo "OpenCV_DIR=$OPENCV_DIR" >> $GITHUB_ENV
            echo "OpenCV version: $(pkg-config --modversion opencv4)"
          else
            echo "WARNING: OpenCV not found via pkg-config, trying alternative methods..."
            # Try common OpenCV config locations
            for dir in \
              "/usr/local/lib/cmake/opencv4" \
              "/usr/lib/x86_64-linux-gnu/cmake/opencv4" \
              "/opt/opencv/build" \
              "/opt/opencv4/build"; do
              if [ -f "$dir/OpenCVConfig.cmake" ]; then
                echo "Found OpenCV in $dir"
                echo "OpenCV_DIR=$dir" >> $GITHUB_ENV
                export OpenCV_DIR="$dir"
                break
              fi
            done
          fi

          # Verify OpenCV is found
          if [ -n "${OpenCV_DIR:-}" ] && [ -f "${OpenCV_DIR}/OpenCVConfig.cmake" ]; then
            echo "OpenCV configuration verified at ${OpenCV_DIR}"
          else
            echo "ERROR: OpenCV configuration not found after installation"
            exit 1
          fi

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: cpp
          config-file: .github/codeql/codeql-config.yml

      - name: Build with CodeQL
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_CUDA=OFF \
            -DBUILD_TESTS=OFF \
            -DOpenCV_DIR="${OpenCV_DIR:-/usr/lib/x86_64-linux-gnu/cmake/opencv4}" \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          make -j$(nproc)

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:cpp"

  lint:
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Run pre-commit
        run: pre-commit run --all-files
