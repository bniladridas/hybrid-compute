---
name: CI Sync

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        cpp: ["20"]
        cuda: ["12.6"]
        python-version: ["3.12"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install CUDA ${{ matrix.cuda }}
        run: |
          # Clean up space first
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          df -h

          # Add NVIDIA repository
          CUDA_REPO="https://developer.download.nvidia.com/compute/cuda"
          wget "${CUDA_REPO}/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb"
          sudo dpkg -i cuda-keyring_1.1-1_all.deb

          # Update package lists and install only what's needed
          sudo apt-get update -o Acquire::Check-Valid-Until=false -o Acquire::Retries=3

          # Install minimal CUDA toolkit and required libraries
          sudo apt-get install -y --no-install-recommends \
            cuda-minimal-build-12-6 \
            cuda-libraries-dev-12-6 \
            libcudnn9-cuda-12 \
            libcudnn9-dev-cuda-12

          # Clean up after installation
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          df -h

          # Remove swap file
          sudo swapoff /swapfile
          sudo rm /swapfile

          # Set up environment variables
          echo "CUDA_HOME=/usr/local/cuda-12.6" >> $GITHUB_ENV
          echo "PATH=/usr/local/cuda-12.6/bin:$PATH" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=/usr/local/cuda-12.6/lib64:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          # Add OpenCV repository for Ubuntu 22.04
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            software-properties-common \
            wget

          # Install OpenCV and development packages
          sudo apt-get install -y --no-install-recommends \
            libopencv-dev \
            libopencv-core-dev \
            libopencv-highgui-dev \
            libopencv-imgproc-dev \
            libopencv-imgcodecs-dev \
            libopencv-videoio-dev \
            libopencv-calib3d-dev \
            libopencv-features2d-dev \
            python3-opencv \
            pkg-config \
            cmake \
            build-essential

          # Add swap space to prevent OOM
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

          # Install OpenCV from source to ensure proper configuration
          echo "Installing OpenCV from source..."
          sudo apt-get update

          # First, install TBB from Ubuntu's repositories
          sudo apt-get install -y --no-install-recommends \
            libtbb-dev

          # Install other build dependencies
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            git \
            libgtk2.0-dev \
            pkg-config \
            libavcodec-dev \
            libavformat-dev \
            libswscale-dev \
            libjpeg-dev \
            libpng-dev \
            libtiff-dev \
            libdc1394-dev

          # Create build directory
          mkdir -p ~/opencv_build
          cd ~/opencv_build

          # Clone OpenCV and opencv_contrib
          git clone https://github.com/opencv/opencv.git
          git clone https://github.com/opencv/opencv_contrib.git

          # Checkout a stable version (4.6.0)
          cd opencv
          git checkout 4.6.0
          cd ../opencv_contrib
          git checkout 4.6.0
          cd ../opencv

          # Create build directory
          mkdir -p build
          cd build

          # Configure with default options
          cmake -D CMAKE_BUILD_TYPE=RELEASE \
                -D CMAKE_INSTALL_PREFIX=/usr/local \
                -D OPENCV_GENERATE_PKGCONFIG=ON \
                -D OPENCV_EXTRA_MODULES_PATH=../../opencv_contrib/modules \
                -D WITH_CUDA=OFF \
                -D WITH_GTK=ON \
                -D WITH_QT=OFF \
                -D WITH_OPENGL=ON \
                -D WITH_VTK=OFF \
                -D WITH_TBB=ON \
                -D WITH_OPENMP=ON \
                -D WITH_FFMPEG=ON \
                -D INSTALL_C_EXAMPLES=OFF \
                -D INSTALL_PYTHON_EXAMPLES=OFF \
                -D BUILD_EXAMPLES=OFF \
                -D BUILD_DOCS=OFF \
                -D BUILD_TESTS=OFF \
                -D BUILD_PERF_TESTS=OFF \
                -D BUILD_opencv_java=OFF \
                -D BUILD_opencv_python2=OFF \
                -D BUILD_opencv_python3=ON \
                -D OPENCV_ENABLE_NONFREE=ON ..

          # Build with limited parallel jobs and increased verbosity
          make -j2 VERBOSE=1
          sudo make install
          sudo ldconfig

          # Verify installation
          echo "OpenCV version: $(pkg-config --modversion opencv4)"
          echo "Setting OpenCV_DIR to /usr/local/lib/cmake/opencv4"
          echo "OpenCV_DIR=/usr/local/lib/cmake/opencv4" >> $GITHUB_ENV

          # Run the custom dependency installation script
          chmod +x scripts/ci/install_dependencies.sh
          export USE_CUDA=1
          export CI=true
          # Use sudo to run the installation
          sudo -E ./scripts/ci/install_dependencies.sh

      - name: Configure CMake
        run: |
          mkdir -p build
          cd build

          # Set up environment variables for CUDA
          export CUDA_HOME=/usr/local/cuda-12.6
          export PATH="${CUDA_HOME}/bin:${PATH}"
          export LD_LIBRARY_PATH="${CUDA_HOME}/lib64:${LD_LIBRARY_PATH:-}"

          # Set CUDA architecture (Ampere/RTX 30xx by default)
          export CUDA_ARCHITECTURES="80"

          # Configure with CUDA and OpenCV support
          echo "Configuring with OpenCV_DIR: ${OpenCV_DIR:-Not found}"
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_CUDA=ON \
            -DCUDA_TOOLKIT_ROOT_DIR="${CUDA_HOME}" \
            -DCUDA_TOOLKIT_ROOT="${CUDA_HOME}" \
            -DCMAKE_CUDA_ARCHITECTURES=${CUDA_ARCHITECTURES} \
            -DCMAKE_CXX_STANDARD=${{ matrix.cpp }} \
            -DCMAKE_CXX_STANDARD_REQUIRED=ON \
            -DBUILD_TESTS=ON \
            -DOpenCV_DIR="${OpenCV_DIR:-/usr/local/lib/cmake/opencv4}"

          # Verify CUDA configuration
          echo "CUDA configuration:"
          cmake -LA . | grep -i cuda

      - name: Build
        run: |
          cd build
          make -j$(nproc)

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure

  codeql-analysis:
    needs: build-and-test
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for CodeQL

      - name: Install OpenCV dependencies
        run: |
          # Add OpenCV repository for Ubuntu 22.04
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            software-properties-common \
            wget

          # Install OpenCV and development packages
          sudo apt-get install -y --no-install-recommends \
            libopencv-dev \
            libopencv-core-dev \
            libopencv-highgui-dev \
            libopencv-imgproc-dev \
            libopencv-imgcodecs-dev \
            libopencv-videoio-dev \
            libopencv-calib3d-dev \
            libopencv-features2d-dev \
            python3-opencv \
            pkg-config \
            cmake \
            build-essential

          # Set OpenCV directory
          if [ -d "/usr/lib/x86_64-linux-gnu/cmake/opencv4" ]; then
            echo "Found OpenCV in /usr/lib/x86_64-linux-gnu/cmake/opencv4"
            echo "OpenCV_DIR=/usr/lib/x86_64-linux-gnu/cmake/opencv4" >> $GITHUB_ENV
          elif [ -d "/usr/local/lib/cmake/opencv4" ]; then
            echo "Found OpenCV in /usr/local/lib/cmake/opencv4"
            echo "OpenCV_DIR=/usr/local/lib/cmake/opencv4" >> $GITHUB_ENV
          else
            echo "ERROR: OpenCV not found in standard locations"
            exit 1
          fi

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: cpp
          config-file: .github/codeql/codeql-config.yml

      - name: Build with CodeQL
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_CUDA=OFF \
            -DBUILD_TESTS=OFF \
            -DCMAKE_CXX_STANDARD=${{ matrix.cpp }} \
            -DCMAKE_CXX_STANDARD_REQUIRED=ON \
            -DOpenCV_DIR="${OpenCV_DIR}" \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

          # Build with CodeQL
          cmake --build . --config Release
