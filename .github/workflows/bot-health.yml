---
name: Bot Health Check

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:
  push:
    paths:
      - '.github/**'

jobs:
  check-bots:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check Dependabot Config
        run: |
          echo "[INFO] Checking Dependabot configuration..."
          if [ -f ".github/dependabot.yml" ]; then
            echo "[PASS] Dependabot config exists"
            python3 -c "import yaml; yaml.safe_load(open('.github/dependabot.yml'))"
            echo "[PASS] Dependabot YAML is valid"
          else
            echo "[FAIL] Dependabot config missing"
            exit 1
          fi

      - name: Check Workflows
        run: |
          echo "[INFO] Checking GitHub Actions workflows..."
          workflow_count=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | wc -l)
          echo "[INFO] Found $workflow_count workflow files"

          for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$workflow" ]; then
              echo "[PASS] $(basename "$workflow")"
              python3 -c "import yaml; yaml.safe_load(open('$workflow'))"
            fi
          done

      - name: Check Pre-commit Config
        run: |
          echo "[INFO] Checking pre-commit configuration..."
          if [ -f ".pre-commit-config.yaml" ]; then
            echo "[PASS] Pre-commit config exists"
            python3 -c "import yaml; yaml.safe_load(open('.pre-commit-config.yaml'))"
            echo "[PASS] Pre-commit YAML is valid"
          else
            echo "[FAIL] Pre-commit config missing"
          fi

      - name: Check Git Hooks
        run: |
          echo "[INFO] Checking Git hooks..."
          if [ -f "scripts/commit-msg" ]; then
            echo "[PASS] Commit message hook exists"
            if [ -x "scripts/commit-msg" ]; then
              echo "[PASS] Commit hook is executable"
            else
              echo "[WARN] Commit hook not executable"
            fi
          else
            echo "[FAIL] Commit message hook missing"
          fi

      - name: E2E Bot Testing
        run: |
          echo "[INFO] Running end-to-end bot tests..."

          # Test git user configuration
          echo "[INFO] Testing git user configuration..."
          git_user=$(git config user.name)
          git_email=$(git config user.email)
          if [ "$git_user" = "github-actions[bot]" ] && [ "$git_email" = "github-actions[bot]@users.noreply.github.com" ]; then
            echo "[PASS] Git user configured as github-actions[bot]"
          else
            echo "[FAIL] Git user not properly configured: $git_user <$git_email>"
            exit 1
          fi

          # Test commit message hook
          echo "[INFO] Testing commit message validation..."
          echo "feat(test): valid commit message" > /tmp/test_commit
          if bash scripts/commit-msg /tmp/test_commit; then
            echo "[PASS] Commit message hook works"
          else
            echo "[FAIL] Commit message hook failed"
            exit 1
          fi

          # Test invalid commit message
          echo "Invalid commit message" > /tmp/test_commit_invalid
          if ! bash scripts/commit-msg /tmp/test_commit_invalid 2>/dev/null; then
            echo "[PASS] Commit message hook correctly rejects invalid messages"
          else
            echo "[FAIL] Commit message hook should reject invalid messages"
            exit 1
          fi

          echo "[PASS] All E2E bot tests completed successfully!"

      - name: Bot Status Summary
        run: |
          echo "## Bot Health Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Bot/Service | Status | Config File |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependabot | [PASS] Active | .github/dependabot.yml |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Actions | [PASS] Active | .github/workflows/ |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-commit | [PASS] Active | .pre-commit-config.yaml |" >> $GITHUB_STEP_SUMMARY
          echo "| Git Hooks | [PASS] Active | scripts/commit-msg |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[PASS] All bots and automation are properly configured!"
