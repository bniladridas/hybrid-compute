---
name: Smart Bot Health Check

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    paths:
      - '.github/**'

jobs:
  smart-bot-check:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Smart Analysis
        id: analysis
        run: |
          echo "[INFO] Running smart bot analysis..."
          total=0; passed=0; failed=0

          # Check Dependabot
          if [ -f ".github/dependabot.yml" ]; then
            ecosystems=$(grep -c "package-ecosystem:" .github/dependabot.yml)
            echo "[PASS] Dependabot: $ecosystems ecosystems"
            passed=$((passed + 1))
          else
            echo "[FAIL] Dependabot missing"
            failed=$((failed + 1))
          fi
          total=$((total + 1))

          # Check workflows
          workflows=$(find .github/workflows -name "*.yml" | wc -l)
          if [ $workflows -gt 0 ]; then
            echo "[PASS] GitHub Actions: $workflows workflows"
            passed=$((passed + 1))
          else
            echo "[FAIL] No workflows found"
            failed=$((failed + 1))
          fi
          total=$((total + 1))

          # Check pre-commit
          if [ -f ".pre-commit-config.yaml" ]; then
            hooks=$(grep -c "- id:" .pre-commit-config.yaml || echo "0")
            echo "[PASS] Pre-commit: $hooks hooks"
            passed=$((passed + 1))
          else
            echo "[FAIL] Pre-commit missing"
            failed=$((failed + 1))
          fi
          total=$((total + 1))

          # Calculate health score
          health_score=$(( (passed * 100) / total ))
          echo "health_score=$health_score" >> $GITHUB_OUTPUT
          echo "passed=$passed" >> $GITHUB_OUTPUT
          echo "failed=$failed" >> $GITHUB_OUTPUT
          echo "total=$total" >> $GITHUB_OUTPUT

          echo "[INFO] Health Score: $health_score% ($passed/$total)"

      - name: E2E Testing
        run: |
          echo "[INFO] Running E2E tests..."

          # Test git config
          user=$(git config user.name)
          email=$(git config user.email)
          if [ "$user" = "github-actions[bot]" ]; then
            echo "[PASS] Git user configured correctly"
          else
            echo "[FAIL] Git user misconfigured: $user"
            exit 1
          fi

          # Test commit hook
          echo "feat(test): valid message" > /tmp/test
          if bash scripts/commit-msg /tmp/test; then
            echo "[PASS] Commit hook works"
          else
            echo "[FAIL] Commit hook failed"
            exit 1
          fi

          echo "[PASS] All E2E tests passed"

      - name: Generate Report
        run: |
          health=${{ steps.analysis.outputs.health_score }}
          passed=${{ steps.analysis.outputs.passed }}
          failed=${{ steps.analysis.outputs.failed }}
          total=${{ steps.analysis.outputs.total }}

          status="GOOD"
          if [ $health -ge 90 ]; then status="EXCELLENT"; fi
          if [ $health -lt 75 ]; then status="NEEDS_ATTENTION"; fi
          if [ $health -lt 50 ]; then status="CRITICAL"; fi

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Smart Bot Health Report

          ### Overall Status: $status ($health%)

          | Metric | Value |
          |--------|-------|
          | Health Score | $health% |
          | Passed Checks | $passed/$total |
          | Failed Checks | $failed |

          ### Services Status
          - Dependabot: [ACTIVE]
          - GitHub Actions: [ACTIVE]
          - Pre-commit: [ACTIVE]
          - Git Hooks: [ACTIVE]

          *Generated: $(date)*
          EOF

      - name: Create Issue on Failure
        if: steps.analysis.outputs.health_score < 75
        uses: actions/github-script@v7
        with:
          script: |
            const health = ${{ steps.analysis.outputs.health_score }};
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Bot Health Alert: ${health}% health score`,
              body: `Automated bot health check failed with ${health}% score.

              Check the workflow run for details: ${context.payload.repository.html_url}/actions/runs/${context.runId}`,
              labels: ['automation', 'health-check']
            });
