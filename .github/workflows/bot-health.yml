---
name: Bot Health Check

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:
  push:
    paths:
      - '.github/**'

jobs:
  check-bots:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check Dependabot Config
        run: |
          echo "[INFO] Checking Dependabot configuration..."
          if [ -f ".github/dependabot.yml" ]; then
            echo "[PASS] Dependabot config exists"
            # Validate YAML syntax
            python3 -c "import yaml; yaml.safe_load(open('.github/dependabot.yml'))"
            echo "[PASS] Dependabot YAML is valid"
          else
            echo "[FAIL] Dependabot config missing"
            exit 1
          fi

      - name: Check Workflows
        run: |
          echo "[INFO] Checking GitHub Actions workflows..."
          workflow_count=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | wc -l)
          echo "[INFO] Found $workflow_count workflow files"

          for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$workflow" ]; then
              echo "[PASS] $(basename "$workflow")"
              # Validate YAML syntax
              python3 -c "import yaml; yaml.safe_load(open('$workflow'))"
            fi
          done

      - name: Check Pre-commit Config
        run: |
          echo "[INFO] Checking pre-commit configuration..."
          if [ -f ".pre-commit-config.yaml" ]; then
            echo "[PASS] Pre-commit config exists"
            python3 -c "import yaml; yaml.safe_load(open('.pre-commit-config.yaml'))"
            echo "[PASS] Pre-commit YAML is valid"
          else
            echo "[FAIL] Pre-commit config missing"
          fi

      - name: Check CircleCI Config
        run: |
          echo "[INFO] Checking CircleCI configuration..."
          if [ -f ".circleci/config.yml" ]; then
            echo "[PASS] CircleCI config exists"
            python3 -c "import yaml; yaml.safe_load(open('.circleci/config.yml'))"
            echo "[PASS] CircleCI YAML is valid"
          else
            echo "[WARN] CircleCI config not found (optional)"
          fi

      - name: Check Git Hooks
        run: |
          echo "[INFO] Checking Git hooks..."
          if [ -f "scripts/commit-msg" ]; then
            echo "[PASS] Commit message hook exists"
            if [ -x "scripts/commit-msg" ]; then
              echo "[PASS] Commit hook is executable"
            else
              echo "[WARN] Commit hook not executable"
            fi
          else
            echo "[FAIL] Commit message hook missing"
          fi

      - name: Bot Status Summary
        run: |
          echo "## Bot Health Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Bot/Service | Status | Config File |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependabot | [PASS] Active | .github/dependabot.yml |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Actions | [PASS] Active | .github/workflows/ |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-commit | [PASS] Active | .pre-commit-config.yaml |" >> $GITHUB_STEP_SUMMARY
          echo "| CircleCI | [PASS] Active | .circleci/config.yml |" >> $GITHUB_STEP_SUMMARY
          echo "| Git Hooks | [PASS] Active | scripts/commit-msg |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[PASS] All bots and automation are properly configured!"
