---
name: Commit Flow Alignment

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  align-commit-flow:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 50

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Analyze Commit Patterns
        id: analysis
        run: |
          echo "[INFO] Analyzing commit flow patterns..."

          commits=$(git log --oneline -20 --pretty=format:"%h|%s" --date=short)
          total=0; conventional=0; noise=0

          while IFS='|' read -r hash subject; do
            total=$((total + 1))
            pattern="^(feat|fix|docs|style|refactor|test|chore|perf|ci|build)\([a-z-]+\):"
            if [[ "$subject" =~ $pattern ]]; then
              conventional=$((conventional + 1))
              echo "[ALIGN] $hash: ${subject:0:50}..."
            else
              noise=$((noise + 1))
              echo "[NOISE] $hash: ${subject:0:50}..."
            fi
          done <<< "$commits"

          alignment=$(( total > 0 ? (conventional * 100) / total : 0 ))

          echo "total_commits=$total" >> $GITHUB_OUTPUT
          echo "conventional_commits=$conventional" >> $GITHUB_OUTPUT
          echo "noise_commits=$noise" >> $GITHUB_OUTPUT
          echo "alignment_score=$alignment" >> $GITHUB_OUTPUT

          echo "[INFO] Flow alignment: $alignment% ($conventional/$total)"

      - name: Generate Flow Report
        run: |
          alignment=${{ steps.analysis.outputs.alignment_score }}
          conventional=${{ steps.analysis.outputs.conventional_commits }}
          total=${{ steps.analysis.outputs.total_commits }}
          noise=${{ steps.analysis.outputs.noise_commits }}

          if [ $alignment -ge 90 ]; then
            status="HARMONIZED"; icon="[====]"
          elif [ $alignment -ge 75 ]; then
            status="ALIGNED"; icon="[===.]"
          elif [ $alignment -ge 50 ]; then
            status="STABILIZING"; icon="[==..]"
          else
            status="FRAGMENTING"; icon="[=...]"
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Commit Flow Analysis

          ### Status: $status ($alignment%)
          \`\`\`
          $icon Flow Depth: $alignment%
          \`\`\`

          | Metric | Value |
          |--------|-------|
          | Total | $total |
          | Aligned | $conventional |
          | Fragmented | $noise |

          ### Guidance
          $([ $alignment -lt 90 ] && echo "- Pattern: \`type(scope): description\`")
          $([ $noise -gt 2 ] && echo "- Focus: Clear, structured messages")
          $([ $alignment -ge 75 ] && echo "- Flow: Well maintained" || echo "- Flow: Needs strengthening")

          *Persistent clarity through consistent patterns*
          EOF

      - name: Gentle Alignment
        if: steps.analysis.outputs.alignment_score < 50
        run: |
          echo "[INFO] Applying gentle flow alignment..."
          alignment=${{ steps.analysis.outputs.alignment_score }}

          if [ $alignment -lt 30 ]; then
            echo "# Commit Flow Guide

Maintains development consistency through structured patterns.

## Pattern
\`type(scope): clear description\`

## Types
- feat: new features
- fix: bug fixes  
- docs: documentation
- style: formatting
- refactor: code restructure
- test: testing
- chore: maintenance

Generated: $(date)" > .github/FLOW_GUIDE.md

            git add .github/FLOW_GUIDE.md
            git commit -m "docs(flow): add alignment guide" || echo "[INFO] No changes"
          fi

      - name: Flow Persistence
        run: |
          echo "[INFO] Verifying flow persistence..."

          if [ -f "scripts/commit-msg" ] && [ -x "scripts/commit-msg" ]; then
            echo "[PASS] Commit validation active"
          else
            echo "[WARN] Validation needs attention"
          fi

          echo "[PASS] Flow persistence maintained"
