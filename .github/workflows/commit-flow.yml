---
name: Commit Flow Alignment

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  align-flow:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 30

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Analyze Flow
        id: flow
        run: |
          echo "[INFO] Analyzing commit flow..."

          total=0; aligned=0
          pattern="^(feat|fix|docs|style|refactor|test|chore|perf|ci|build)\("

          while read -r subject; do
            total=$((total + 1))
            if [[ "$subject" =~ $pattern ]]; then
              aligned=$((aligned + 1))
            fi
          done < <(git log --oneline -20 --pretty=format:"%s")

          score=$(( total > 0 ? (aligned * 100) / total : 0 ))

          echo "score=$score" >> $GITHUB_OUTPUT
          echo "aligned=$aligned" >> $GITHUB_OUTPUT
          echo "total=$total" >> $GITHUB_OUTPUT

          echo "[INFO] Flow score: $score% ($aligned/$total aligned)"

      - name: Flow Report
        run: |
          score=${{ steps.flow.outputs.score }}
          aligned=${{ steps.flow.outputs.aligned }}
          total=${{ steps.flow.outputs.total }}

          if [ $score -ge 80 ]; then
            status="HARMONIZED"
          elif [ $score -ge 60 ]; then
            status="ALIGNED"
          else
            status="FRAGMENTING"
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Commit Flow: $status ($score%)

          | Metric | Value |
          |--------|-------|
          | Aligned | $aligned/$total |
          | Score | $score% |
          | Status | $status |

          ### Flow Pattern
          \`type(scope): description\`

          *Maintains persistent clarity through structured commits*
          EOF

      - name: Gentle Correction
        if: steps.flow.outputs.score < 40
        run: |
          echo "[INFO] Applying gentle flow correction..."

          cat > .github/FLOW.md << 'EOF'
          # Flow Alignment

          Structured commit patterns for consistent development flow.

          Pattern: `type(scope): clear description`
          EOF

          git add .github/FLOW.md
          git commit -m "docs(flow): maintain alignment patterns" || true

      - name: Verify Persistence
        run: |
          if [ -f "scripts/commit-msg" ] && [ -x "scripts/commit-msg" ]; then
            echo "[PASS] Flow validation active"
          else
            echo "[WARN] Flow validation inactive"
          fi
