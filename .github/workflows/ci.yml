---
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ────────────────────────────── Code Scanning ──────────────────────────────
  codeql:
    runs-on: ubuntu-24.04
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: ['cpp', 'python']  # cpp covers C and C++
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ────────────────────────────── Lint & Polish ──────────────────────────────
  lint-and-polish:
    needs: codeql
    runs-on: ubuntu-24.04
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Run linters
        run: pre-commit run --all-files

      - name: Commit fixes
        if: github.event_name == 'pull_request'
        run: |
           if [ -n "$(git status --porcelain)" ]; then
             git config --global user.name 'github-actions[bot]'
             git config --global user.email 'github-actions[bot]@users.noreply.github.com'
             git add .
             git commit -m "fix: auto-fix lint issues"
             git push
           fi

  # ────────────────────────────── Python Tests ──────────────────────────────
  python-tests:
    needs: lint-and-polish
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Python tests
        run: |
          pytest --cov=. --cov-report=xml

      - name: Test Python scripts
        run: |
          python create_test_image.py
          python scripts/stitch.py --help || true  # Test script execution

  # ────────────────────────────── Build & Test ──────────────────────────────
  test-and-build:
    needs: lint-and-polish
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            cuda: ""
            tag: "-cpu"
          - os: windows-latest
            cuda: ""
            tag: "-windows"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update && sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            cmake build-essential libopencv-dev git \
             && sudo rm -rf /var/lib/apt/lists/*

      - name: Install CUDA
        if: runner.os == 'Linux'
        uses: ./.github/actions/install-cuda

      - name: Create build directory
        run: mkdir -p build

      - name: Cache build dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/Library/Caches/pip
            %USERPROFILE%\AppData\Local\pip\Cache
            build/_deps
          key: "${{ runner.os }}-build-${{ matrix.cuda }}-${{ hashFiles('**/CMakeLists.txt') }}"
          restore-keys: |
            ${{ runner.os }}-build-${{ matrix.cuda }}-
            ${{ runner.os }}-build-

      - name: Build & Test
        shell: bash
        run: |
          mkdir -p build
          cd build
           if [ "${{ matrix.cuda }}" != "" ]; then
             cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_CUDA=ON \
               -DWITH_OPENCV=ON -DCMAKE_CUDA_ARCHITECTURES=$CMAKE_CUDA_ARCHITECTURES
           else
             cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_CUDA=OFF -DWITH_OPENCV=ON
           fi
          if [ "$RUNNER_OS" == "Windows" ]; then
            cmake --build . --config Release --parallel $NUMBER_OF_PROCESSORS
          else
            make -j$(nproc)
           fi
           if [ "$RUNNER_OS" == "Windows" ]; then
             ctest -C Release --output-on-failure --timeout 300 --parallel $NUMBER_OF_PROCESSORS
            else
              # Run benchmark test with verbose output
              ctest -R user_counters_tabular_test -V --timeout 300
              # Run other tests with output on failure
              ctest -E user_counters_tabular_test \
                --output-on-failure --timeout 300 --parallel $(nproc)
            fi

  # ────────────────────────────── Build CUDA ──────────────────────────────
  build-cuda:
    needs: lint-and-polish
    runs-on: ubuntu-24.04
    timeout-minutes: 90
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        run: |
          sudo apt-get update && sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            cmake build-essential libopencv-dev git \
            && sudo rm -rf /var/lib/apt/lists/*

      - name: Install CUDA
        uses: ./.github/actions/install-cuda

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create build directory
        run: mkdir -p build

      - name: Cache build dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            build/_deps
          key: "ubuntu-build-13.0.1-${{ hashFiles('**/CMakeLists.txt') }}"
          restore-keys: |
            ubuntu-build-13.0.1-
            ubuntu-build-

      - name: Build project
        run: |
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_CUDA=ON \
            -DWITH_OPENCV=ON -DENABLE_BENCHMARK=ON \
            -DCMAKE_CUDA_ARCHITECTURES=$CMAKE_CUDA_ARCHITECTURES
          make -j$(nproc)

      - name: Run E2E tests
        run: python scripts/e2e.py

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-cuda-artifacts
          path: build/

  # ────────────────────────────── Build Metal ──────────────────────────────
  build-metal:
    needs: lint-and-polish
    runs-on: macos-latest
    timeout-minutes: 90
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (macOS)
        run: |
          brew update
          brew install cmake opencv

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create build directory
        run: mkdir -p build

      - name: Cache build dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            build/_deps
          key: "macos-build-${{ hashFiles('**/CMakeLists.txt') }}"
          restore-keys: |
            macos-build-

      - name: Build project
        run: |
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_CUDA=OFF -DWITH_OPENCV=ON
          make -j$(sysctl -n hw.ncpu)

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure --timeout 300 --parallel $(sysctl -n hw.ncpu)

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-metal-artifacts
          path: build/

  # ────────────────────────────── Code Coverage ──────────────────────────────
  coverage:
    needs: lint-and-polish
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install CUDA
        uses: ./.github/actions/install-cuda

      - name: Install lcov
        run: |
          export PATH=/usr/bin:/bin:$PATH
          /usr/bin/sudo /usr/bin/apt-get update
          /usr/bin/sudo /usr/bin/apt-get install -y lcov libopencv-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create build directory
        run: mkdir -p build

      - name: Cache build dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            build/_deps
          key: "ubuntu-coverage-${{ hashFiles('**/CMakeLists.txt') }}"
          restore-keys: |
            ubuntu-coverage-

      - name: Build with coverage
        run: |
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Debug -DUSE_CUDA=ON \
            -DWITH_OPENCV=ON -DCOVERAGE=ON -DCMAKE_CUDA_ARCHITECTURES=$CMAKE_CUDA_ARCHITECTURES
          make -j$(nproc)

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure --timeout 300 --parallel $(nproc)

      - name: Generate coverage report
        run: |
          cd build
          lcov --capture --directory . --exclude '*/_deps/*' --output-file coverage.info
          lcov --remove coverage.info '/usr/*' --output-file coverage.info
          genhtml coverage.info --output-directory coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: build/coverage.info
          flags: c++
          name: C++ Coverage

  # ────────────────────────────── Performance Benchmarks ──────────────────────────────
  benchmark:
    needs: build-metal
    runs-on: macos-latest
    timeout-minutes: 30
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-metal-artifacts
          path: build

      - name: Set executable permissions
        run: chmod +x build/bin/*

      - name: Run benchmarks
        run: |
          cd build
          ./bin/benchmark_metal_shim --benchmark_min_time=1s

  # ────────────────────────────── Cross-Platform CUDA ──────────────────────────────
  windows-cuda:
    needs: lint-and-polish
    runs-on: windows-latest
    timeout-minutes: 90
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build CUDA in WSL
        uses: Vampire/setup-wsl@v3
        with:
          distribution: Ubuntu-22.04
          wsl-shell-user: root
          wsl-shell-command: |
            apt-get update
            apt-get install -y cmake build-essential libopencv-dev git
            bash scripts/install_cuda.sh
            python3 -m pip install --upgrade pip
            pip install -r requirements.txt
            mkdir build
            cd build
            cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_CUDA=ON \
              -DWITH_OPENCV=ON -DCMAKE_CUDA_ARCHITECTURES=$CMAKE_CUDA_ARCHITECTURES
            make -j$(nproc)
            ctest --output-on-failure --timeout 300 --parallel $(nproc)

  # ────────────────────────────── Documentation ──────────────────────────────
  docs:
    needs: lint-and-polish
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install MkDocs
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs

      - name: Build documentation
        run: mkdocs build

      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site

  # ────────────────────────────── Docker Build & Test ──────────────────────────────
  docker:
    needs: [test-and-build, build-cuda, build-metal]
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    permissions:
      contents: read
      packages: write
      security-events: write
    strategy:
      matrix:
        include:
          - cuda-version: "13.0.1"
            tag-suffix: ""
          - cuda-version: ""
            tag-suffix: "-cpu"
    steps:
      - uses: actions/checkout@v4

      - name: Install test dependencies
        run: pip3 install --break-system-packages -r requirements.txt

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image tags
        run: |
          REG="ghcr.io"
          OWNER="${{ github.repository_owner }}"
          if [ "${{ matrix.cuda-version }}" != "" ]; then
            NAME="hybrid-compute-gpu"
          else
            NAME="hybrid-compute-cpu"
          fi
          TAG_BASE="$REG/$OWNER/$NAME"
          echo "IMAGE_TAG1=$TAG_BASE:${{ github.sha }}" >> $GITHUB_ENV
          echo "IMAGE_TAG2=$TAG_BASE:latest${{ matrix.tag-suffix }}" >> $GITHUB_ENV

      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.cuda-version != '' && 'Dockerfile.cuda' || 'Dockerfile' }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.IMAGE_TAG1 }}
            ${{ env.IMAGE_TAG2 }}
          build-args: |
            BUILDKIT_INLINE_CACHE=1
          cache-from: type=gha
          cache-to: type=gha,mode=max
          retry: 3
          retry-delay: 10

      - name: Test container execution
        if: github.event_name != 'pull_request'
        run: |
          mkdir -p test_images
          python3 create_test_image.py
          cp test_images/test.jpg test_images/input.jpg

           GPU="${{ matrix.cuda-version != '' && 'true' || 'false' }}"
            if [ "$GPU" = "true" ]; then
              docker run --entrypoint bash "${{ env.IMAGE_TAG1 }}" \
                -c "ls -l /app/ && test -f /app/upscale && echo OK"
            else
              echo "Running CPU mode..."
                   docker run --entrypoint bash "${{ env.IMAGE_TAG1 }}" \
                     -c "ls -l /app/ && test -f /app/preprocess_c && echo OK"
            fi

      - name: Scan image with Trivy
        if: github.event_name != 'pull_request'
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          scan-ref: '${{ env.IMAGE_TAG1 }}'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        if: github.event_name != 'pull_request'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # ────────────────────────────── Dependabot Auto-Merge ──────────────────────────────
  dependabot-auto-merge:
    needs: docker
    runs-on: ubuntu-24.04
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Merge Dependabot PR
        env:
          GH_TOKEN: ${{ secrets.DEPENDABOT_MERGE_TOKEN }}
        run: gh pr merge ${{ github.event.pull_request.number }} --squash --delete-branch=false

  # ────────────────────────────── Automated Release ──────────────────────────────
  release:
    needs: docker
    runs-on: ubuntu-24.04
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Create release
        uses: googleapis/release-please-action@v4
        with:
          skip-github-pull-request: true
          token: ${{ secrets.GITHUB_TOKEN }}
