---
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ────────────────────────────── Code Scanning ──────────────────────────────
  codeql:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: ['cpp', 'python']  # cpp covers C and C++
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ────────────────────────────── Lint & Polish ──────────────────────────────
  lint-and-polish:
    needs: codeql
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Run linters
        run: pre-commit run --all-files

  # ────────────────────────────── Python Tests ──────────────────────────────
  python-tests:
    needs: lint-and-polish
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Python tests
        run: |
          pytest --cov=. --cov-report=xml

      - name: Test Python scripts
        run: |
          python create_test_image.py
          python scripts/stitch.py --help || true  # Test script execution

  # ────────────────────────────── Build & Test ──────────────────────────────
  test-and-build:
    needs: lint-and-polish
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            cuda: "13.0.1"
            tag: ""
          - os: ubuntu-latest
            cuda: ""
            tag: "-cpu"
          - os: macos-latest
            cuda: ""
            tag: "-macos"
          - os: windows-latest
            cuda: ""
            tag: "-windows"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update && sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            cmake build-essential libopencv-dev git \
            && sudo rm -rf /var/lib/apt/lists/*

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install cmake opencv

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install cmake opencv

      - name: Create build directory
        run: mkdir -p build

      - name: Cache build dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/Library/Caches/pip
            %USERPROFILE%\AppData\Local\pip\Cache
            build/_deps
          key: "${{ runner.os }}-build-${{ matrix.cuda }}-${{ hashFiles('**/CMakeLists.txt') }}"
          restore-keys: |
            ${{ runner.os }}-build-${{ matrix.cuda }}-
            ${{ runner.os }}-build-

      - name: Build & Test
        shell: bash
        run: |
          mkdir -p build
          cd build
          if [ "${{ matrix.cuda }}" != "" ]; then
            cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_CUDA=ON -DWITH_OPENCV=ON
          else
            cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_CUDA=OFF -DWITH_OPENCV=ON
          fi
          if [ "$RUNNER_OS" == "Windows" ]; then
            cmake --build . --config Release --parallel $NUMBER_OF_PROCESSORS
          else
            make -j$(nproc)
          fi
          if [ "$RUNNER_OS" == "Windows" ]; then
            ctest -C Release --output-on-failure --timeout 300 --parallel $NUMBER_OF_PROCESSORS
           else
             ctest --output-on-failure --timeout 300 --parallel $(nproc)
           fi
      - name: Run Benchmark Test (macOS)
        if: runner.os == 'macOS'
        run: |
          cd build
          ctest -R user_counters_tabular_test -V --timeout 300

  # ────────────────────────────── Docker Build & Test ──────────────────────────────
  docker:
    needs: test-and-build
    runs-on: ubuntu-latest
    timeout-minutes: 120
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - cuda-version: "13.0.1"
            tag-suffix: ""
          - cuda-version: ""
            tag-suffix: "-cpu"
    steps:
      - uses: actions/checkout@v4

      - name: Install test dependencies
        run: pip3 install --break-system-packages -r requirements.txt

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image tags
        run: |
          REG="ghcr.io"
          OWNER="${{ github.repository_owner }}"
          if [ "${{ matrix.cuda-version }}" != "" ]; then
            NAME="hybrid-compute-gpu"
          else
            NAME="hybrid-compute-cpu"
          fi
          TAG_BASE="$REG/$OWNER/$NAME"
          echo "IMAGE_TAG1=$TAG_BASE:${{ github.sha }}" >> $GITHUB_ENV
          echo "IMAGE_TAG2=$TAG_BASE:latest${{ matrix.tag }}" >> $GITHUB_ENV

      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.cuda-version != '' && 'Dockerfile.cuda' || 'Dockerfile' }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.IMAGE_TAG1 }}
            ${{ env.IMAGE_TAG2 }}
          build-args: |
            BUILDKIT_INLINE_CACHE=1
          cache-from: type=gha
          cache-to: type=gha,mode=max
          retry: 3
          retry-delay: 10

      - name: Test container execution
        if: github.event_name != 'pull_request'
        run: |
          mkdir -p test_images
          python3 create_test_image.py
          cp test_images/test.jpg test_images/input.jpg

           GPU="${{ matrix.cuda-version != '' && 'true' || 'false' }}"
            if [ "$GPU" = "true" ]; then
              docker run --entrypoint bash "${{ env.IMAGE_TAG1 }}" \
                -c "ls -l /app/ && test -f /app/upscale && echo OK"
            else
              echo "Running CPU mode..."
                   docker run --entrypoint bash "${{ env.IMAGE_TAG1 }}" \
                     -c "ls -l /app/ && test -f /app/preprocess_c && echo OK"
            fi

  # ────────────────────────────── Dependabot Auto-Merge ──────────────────────────────
  dependabot-auto-merge:
    needs: docker
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Merge Dependabot PR
        env:
          GH_TOKEN: ${{ secrets.DEPENDABOT_MERGE_TOKEN }}
        run: gh pr merge ${{ github.event.pull_request.number }} --squash --delete-branch=false

  # ────────────────────────────── Automated Release ──────────────────────────────
  release:
    needs: docker
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Create release
        uses: googleapis/release-please-action@v4
        with:
          skip-github-pull-request: true
          token: ${{ secrets.GITHUB_TOKEN }}
