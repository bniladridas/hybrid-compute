---
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ────────────────────────────── Code Scanning ──────────────────────────────
  codeql:
    runs-on: ubuntu-24.04
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ['cpp', 'python']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up build tools and OpenCV (for C++ analysis)
        if: matrix.language == 'cpp'
        run: |
          # Install build tools
          sudo apt-get update
          sudo apt-get install -y build-essential cmake pkg-config

          # Install OpenCV dependencies
          sudo apt-get install -y --no-install-recommends \
            libopencv-dev \
            libopencv-core-dev \
            libopencv-highgui-dev \
            libopencv-imgproc-dev \
            libopencv-imgcodecs-dev \
            libopencv-videoio-dev \
            libopencv-calib3d-dev \
            libopencv-features2d-dev \
            python3-opencv

          # Verify OpenCV installation
          echo "Verifying OpenCV installation..."

          # First, try to find OpenCVConfig.cmake directly
          if [ -f "/usr/lib/x86_64-linux-gnu/cmake/opencv4/OpenCVConfig.cmake" ]; then
            echo "Found OpenCV in standard location"
            echo "OpenCV_DIR=/usr/lib/x86_64-linux-gnu/cmake/opencv4" >> $GITHUB_ENV
            export OpenCV_DIR="/usr/lib/x86_64-linux-gnu/cmake/opencv4"
          elif pkg-config --exists opencv4; then
            echo "OpenCV found via pkg-config"
            OPENCV_PKG_DIR=$(pkg-config --variable=libdir opencv4)
            if [ -f "$OPENCV_PKG_DIR/cmake/opencv4/OpenCVConfig.cmake" ]; then
              echo "Found OpenCV config in pkg-config libdir"
              echo "OpenCV_DIR=$OPENCV_PKG_DIR/cmake/opencv4" >> $GITHUB_ENV
              export OpenCV_DIR="$OPENCV_PKG_DIR/cmake/opencv4"
            fi
          fi

          # If still not found, try common locations
          if [ -z "${OpenCV_DIR:-}" ]; then
            echo "Searching for OpenCV in common locations..."
            for dir in \
              "/usr/local/lib/cmake/opencv4" \
              "/usr/lib/x86_64-linux-gnu/cmake/opencv4" \
              "/usr/local/share/opencv4" \
              "/opt/opencv/build" \
              "/opt/opencv4/build"; do
              if [ -f "$dir/OpenCVConfig.cmake" ]; then
                echo "Found OpenCV in $dir"
                echo "OpenCV_DIR=$dir" >> $GITHUB_ENV
                export OpenCV_DIR="$dir"
                break
              fi
            done
          fi

          # Verify OpenCV is found
          if [ -n "${OpenCV_DIR:-}" ] && [ -f "${OpenCV_DIR}/OpenCVConfig.cmake" ]; then
            echo "OpenCV configuration verified at ${OpenCV_DIR}"
            OPENCV_VER=$(grep -oP '(?<=OpenCV_VERSION )[0-9.]+' ${OpenCV_DIR}/OpenCVConfig.cmake)
            echo "OpenCV version: ${OPENCV_VER}"
          else
            echo "ERROR: OpenCV configuration not found after installation"
            exit 1
          fi

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          # Use default configuration with our path filters
          config-file: .github/codeql/codeql-config.yml
          # Use standard query suites
          queries: security-extended,security-and-quality

      - name: Build with CodeQL (C++)
        if: matrix.language == 'cpp'
        env:
          OpenCV_DIR: ${{ env.OpenCV_DIR || '/usr/lib/x86_64-linux-gnu/cmake/opencv4' }}
          CC: ${{ matrix.env.CC }}
          CXX: ${{ matrix.env.CXX }}
        run: |
          # Create build directory and configure with OpenCV
          mkdir -p build && cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_CUDA=OFF \
            -DOpenCV_DIR="${OpenCV_DIR}" \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

          # Build with CodeQL's build tracing
          cmake --build . --config Release -- -j2

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"

  # ────────────────────────────── Lint & Polish ──────────────────────────────
  lint-and-polish:
    needs: codeql
    runs-on: ubuntu-24.04
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Run linters
        run: pre-commit run --all-files

      - name: Commit fixes
        if: github.event_name == 'pull_request'
        run: |
           if [ -n "$(git status --porcelain)" ]; then
             git config --global user.name 'github-actions[bot]'
             git config --global user.email 'github-actions[bot]@users.noreply.github.com'
             git add .
             git commit -m "fix: auto-fix lint issues"
             git push
           fi

  # ────────────────────────────── Python Tests ──────────────────────────────
  python-tests:
    needs: lint-and-polish
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Python tests
        run: |
          pytest --cov=. --cov-report=xml

      - name: Test Python scripts
        run: |
          python create_test_image.py
          python scripts/stitch.py --help || true  # Test script execution

  # ────────────────────────────── Build & Test ──────────────────────────────
  test-and-build:
    needs: lint-and-polish
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            cuda: ""
            tag: "-cpu"
          - os: windows-latest
            cuda: ""
            tag: "-windows"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install OpenCV (Windows)
        if: runner.os == 'Windows'
        uses: lukka/run-vcpkg@v11
        with:
          runVcpkgInstall: opencv
          vcpkgGitCommitId: 'f7423ee180c4b7f4c4bde78b8f577f7f7119f48c'

      - name: Install dependencies and build OpenCV (Linux)
        if: runner.os == 'Linux'
        run: |
          # Update package lists
          sudo apt-get update -y

          # Install build essentials and dependencies
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            cmake \
            build-essential \
            git \
            pkg-config \
            wget \
            unzip \
            yasm \
            checkinstall \
            python3 \
            python3-pip \
            python3-dev \
            python3-numpy \
            libtbb-dev \
            libtbb12 \
            libgtk-3-dev \
            libjpeg-dev \
            libpng-dev \
            libtiff-dev \
            libavcodec-dev \
            libavformat-dev \
            libswscale-dev \
            libv4l-dev \
            libxvidcore-dev \
            libx264-dev \
            libatlas-base-dev \
            gfortran \
            libhdf5-dev \
            libhdf5-serial-dev \
            libopenexr-dev \
            libgstreamer1.0-0 \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libxine2-dev \
            libtesseract-dev \
            liblapack-dev \
            libeigen3-dev \
            libgflags-dev \
            libgoogle-glog-dev \
            libprotobuf-dev \
            protobuf-compiler \
            libleveldb-dev \
            liblmdb-dev \
            libsnappy-dev \
            libboost-all-dev \
            libopencv-dev \
            libopenblas-dev \
            gcc-11 g++-11

          # Function to build OpenCV from source
          build_opencv() {
            echo "Building OpenCV from source..."

            # Create build directory
            mkdir -p ~/opencv_build
            cd ~/opencv_build

            # Clone OpenCV and opencv_contrib
            git clone --depth 1 --branch 4.8.0 https://github.com/opencv/opencv.git
            git clone --depth 1 --branch 4.8.0 https://github.com/opencv/opencv_contrib.git

            # Create build directory
            mkdir -p build && cd build

            # Configure with CMake
            cmake \
              -D CMAKE_BUILD_TYPE=RELEASE \
              -D CMAKE_INSTALL_PREFIX=/usr/local \
              -D OPENCV_GENERATE_PKGCONFIG=ON \
              -D OPENCV_ENABLE_NONFREE=ON \
              -D OPENCV_EXTRA_MODULES_PATH=../opencv_contrib/modules \
              -D BUILD_EXAMPLES=OFF \
              -D INSTALL_PYTHON_EXAMPLES=OFF \
              -D INSTALL_C_EXAMPLES=OFF \
              -D WITH_TBB=ON \
              -D WITH_V4L=ON \
              -D WITH_QT=OFF \
              -D WITH_OPENGL=ON \
              -D WITH_GSTREAMER=ON \
              -D OPENCV_GENERATE_PKGCONFIG=ON \
              -D CMAKE_C_COMPILER=gcc-11 \
              -D CMAKE_CXX_COMPILER=g++-11 \
              -D BUILD_TESTS=OFF \
              -D BUILD_PERF_TESTS=OFF \
              -D BUILD_opencv_java=OFF \
              -D BUILD_opencv_python2=OFF \
              -D BUILD_opencv_python3=ON \
              -D PYTHON3_EXECUTABLE=$(which python3) \
              -D PYTHON3_INCLUDE_DIR=$(python3 -c \
                "from distutils.sysconfig import get_python_inc; print(get_python_inc())") \
              -D PYTHON3_PACKAGES_PATH=$(python3 -c \
                "from distutils.sysconfig import get_python_lib; print(get_python_lib())") \
              -D PYTHON3_LIBRARY=$(python3 -c \
                "from distutils.sysconfig import get_config_var;"\
                "from os.path import dirname,join;"\
                "print(join(dirname(get_config_var('LIBPC')),"\
                "get_config_var('LDLIBRARY')))") \
              ../opencv

            # Build and install
            make -j$(nproc)
            sudo make install
            sudo ldconfig

            # Clean up
            cd ~
            rm -rf ~/opencv_build

            # Set OpenCV_DIR
            echo "OpenCV_DIR=/usr/local/lib/cmake/opencv4" >> $GITHUB_ENV
          }

          # Try to install OpenCV from system packages first
          echo "Attempting to install OpenCV from system packages..."
          if sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
              libopencv-dev \
              libopencv-core-dev \
              libopencv-highgui-dev \
              libopencv-imgproc-dev \
              libopencv-imgcodecs-dev \
              libopencv-videoio-dev; then

            echo "OpenCV installed from system packages"

            # Set OpenCV_DIR if found in standard locations
            if [ -d "/usr/lib/x86_64-linux-gnu/cmake/opencv4" ]; then
              echo "OpenCV_DIR=/usr/lib/x86_64-linux-gnu/cmake/opencv4" >> $GITHUB_ENV
            elif [ -d "/usr/local/lib/cmake/opencv4" ]; then
              echo "OpenCV_DIR=/usr/local/lib/cmake/opencv4" >> $GITHUB_ENV
            fi
          else
            echo "Failed to install OpenCV from system packages, building from source..."
            build_opencv
          fi

          # Verify OpenCV installation
          echo "Verifying OpenCV installation..."
          if [ -z "$OpenCV_DIR" ]; then
            if [ -d "/usr/lib/x86_64-linux-gnu/cmake/opencv4" ]; then
              export OpenCV_DIR=/usr/lib/x86_64-linux-gnu/cmake/opencv4
            elif [ -d "/usr/local/lib/cmake/opencv4" ]; then
              export OpenCV_DIR=/usr/local/lib/cmake/opencv4
            fi
          fi

          if [ -n "$OpenCV_DIR" ]; then
            echo "OpenCV found at: $OpenCV_DIR"
            echo "OpenCV_DIR=$OpenCV_DIR" >> $GITHUB_ENV
          else
            echo "WARNING: OpenCV not found after installation attempts"
            find /usr /opt -name "OpenCVConfig.cmake" -o -name "opencv4.pc" 2>/dev/null || true
          fi

      - name: Install CUDA
        if: runner.os == 'Linux'
        uses: ./.github/actions/install-cuda

      - name: Install OpenCV (Windows)
        if: runner.os == 'Windows'
        uses: lukka/run-vcpkg@v11
        with:
          runVcpkgInstall: opencv
          vcpkgGitCommitId: 'f7423ee180c4b7f4c4bde78b8f577f7f7119f48c'

      - name: Create build directory
        run: mkdir -p build

      - name: Cache build dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/Library/Caches/pip
            %USERPROFILE%\AppData\Local\pip\Cache
            build/_deps
          key: "${{ runner.os }}-build-${{ matrix.cuda }}-${{ hashFiles('**/CMakeLists.txt') }}"
          restore-keys: |
            ${{ runner.os }}-build-${{ matrix.cuda }}-
            ${{ runner.os }}-build-

      - name: Build & Test
        shell: bash
        run: |
          mkdir -p build
          cd build
           # Print environment for debugging
          echo "Environment variables:"
          env | sort

          # Configure with OpenCV
          if [ "${{ matrix.cuda }}" != "" ]; then
            cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_CUDA=ON \
              -DWITH_OPENCV=ON \
              -DCMAKE_CUDA_ARCHITECTURES=$CMAKE_CUDA_ARCHITECTURES \
              -DOpenCV_DIR=${{ env.OpenCV_DIR }} \
              -DCMAKE_VERBOSE_MAKEFILE=ON
          else
            cmake .. -DCMAKE_BUILD_TYPE=Release \
              -DUSE_CUDA=OFF \
              -DWITH_OPENCV=ON \
              -DOpenCV_DIR=${{ env.OpenCV_DIR }} \
              -DCMAKE_VERBOSE_MAKEFILE=ON
          fi
          if [ "$RUNNER_OS" == "Windows" ]; then
            cmake --build . --config Release --parallel $NUMBER_OF_PROCESSORS
          else
            make -j$(nproc)
           fi
           if [ "$RUNNER_OS" == "Windows" ]; then
             ctest -C Release --output-on-failure --timeout 300 --parallel $NUMBER_OF_PROCESSORS
            else
              # Run benchmark test with verbose output
              ctest -R user_counters_tabular_test -V --timeout 300
              # Run other tests with output on failure
              ctest -E user_counters_tabular_test \
                --output-on-failure --timeout 300 --parallel $(nproc)
            fi

  # ────────────────────────────── Build CUDA ──────────────────────────────
  build-cuda:
    needs: lint-and-polish
    runs-on: ubuntu-24.04
    timeout-minutes: 90
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        run: |
          sudo apt-get update && sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            cmake build-essential libopencv-dev git \
            && sudo rm -rf /var/lib/apt/lists/*

      - name: Install CUDA
        uses: ./.github/actions/install-cuda

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create build directory
        run: mkdir -p build

      - name: Cache build dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            build/_deps
          key: "ubuntu-build-13.0.1-${{ hashFiles('**/CMakeLists.txt') }}"
          restore-keys: |
            ubuntu-build-13.0.1-
            ubuntu-build-

      - name: Build project
        env:
          # Limit parallel jobs to prevent OOM
          CMAKE_BUILD_PARALLEL_LEVEL: 2
          CTEST_PARALLEL_LEVEL: 2
        run: |
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_CUDA=ON \
            -DWITH_OPENCV=ON \
            -DENABLE_BENCHMARK=ON \
            -DCMAKE_CUDA_ARCHITECTURES=$CMAKE_CUDA_ARCHITECTURES \
            -DCMAKE_CUDA_FLAGS="-O3 --ptxas-options=-v" \
            -DCMAKE_CXX_FLAGS="-O3 -DNDEBUG" \
            -DCMAKE_EXE_LINKER_FLAGS="-Wl,--no-as-needed" \
            -DCMAKE_SHARED_LINKER_FLAGS="-Wl,--no-as-needed" \
            -DCMAKE_JOB_POOLS="compile=2,link=1" \
            -DCMAKE_JOB_POOL_COMPILE=compile \
            -DCMAKE_JOB_POOL_LINK=link
          cmake --build . -- -j2 VERBOSE=1

      - name: Run E2E tests
        run: python scripts/e2e.py

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-cuda-artifacts
          path: build/

  # ────────────────────────────── Build Metal ──────────────────────────────
  build-metal:
    needs: lint-and-polish
    runs-on: macos-latest
    timeout-minutes: 90
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (macOS)
        run: |
          brew update
          brew install cmake opencv

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create build directory
        run: mkdir -p build

      - name: Cache build dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            build/_deps
          key: "macos-build-${{ hashFiles('**/CMakeLists.txt') }}"
          restore-keys: |
            macos-build-

      - name: Build project
        run: |
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_CUDA=OFF -DWITH_OPENCV=ON
          make -j$(sysctl -n hw.ncpu)

      - name: Run tests
        run: |
          cd build
          # Run tests with limited parallelism
          ctest --output-on-failure --timeout 300 --parallel 2

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-metal-artifacts
          path: build/

  # ────────────────────────────── Code Coverage ──────────────────────────────
  coverage:
    needs: lint-and-polish
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install CUDA
        uses: ./.github/actions/install-cuda

      - name: Install lcov
        run: |
          export PATH=/usr/bin:/bin:$PATH
          /usr/bin/sudo /usr/bin/apt-get update
          /usr/bin/sudo /usr/bin/apt-get install -y lcov libopencv-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create build directory
        run: mkdir -p build

      - name: Cache build dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            build/_deps
          key: "ubuntu-coverage-${{ hashFiles('**/CMakeLists.txt') }}"
          restore-keys: |
            ubuntu-coverage-

      - name: Build with coverage
        run: |
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Debug -DUSE_CUDA=ON \
            -DWITH_OPENCV=ON -DCOVERAGE=ON -DCMAKE_CUDA_ARCHITECTURES=$CMAKE_CUDA_ARCHITECTURES
          make -j$(nproc)

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure --timeout 300 --parallel $(nproc)

      - name: Generate coverage report
        run: |
          cd build
          lcov --capture --directory . --exclude '*/_deps/*' --output-file coverage.info
          lcov --remove coverage.info '/usr/*' --output-file coverage.info
          genhtml coverage.info --output-directory coverage

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: build/coverage.info
          flags: c++
          name: C++ Coverage

  # ────────────────────────────── Performance Benchmarks ──────────────────────────────
  benchmark:
    needs: build-metal
    runs-on: macos-latest
    timeout-minutes: 30
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-metal-artifacts
          path: build

      - name: Set executable permissions
        run: chmod +x build/bin/*

      - name: Run benchmarks
        run: |
          cd build
          ./bin/benchmark_metal_shim --benchmark_min_time=1s

  # ────────────────────────────── Cross-Platform CUDA ──────────────────────────────
  windows-cuda:
    needs: lint-and-polish
    runs-on: windows-latest
    timeout-minutes: 90
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build CUDA in WSL
        uses: Vampire/setup-wsl@v3
        with:
          distribution: Ubuntu-22.04
          wsl-shell-user: root
          wsl-shell-command: |
            apt-get update
            apt-get install -y cmake build-essential libopencv-dev git
            bash scripts/install_cuda.sh
            python3 -m pip install --upgrade pip
            pip install -r requirements.txt
            mkdir build
            cd build
            cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_CUDA=ON \
              -DWITH_OPENCV=ON -DCMAKE_CUDA_ARCHITECTURES=$CMAKE_CUDA_ARCHITECTURES
            make -j$(nproc)
            ctest --output-on-failure --timeout 300 --parallel $(nproc)

  # ────────────────────────────── Documentation ──────────────────────────────
  docs:
    needs: lint-and-polish
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install MkDocs
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs

      - name: Build documentation
        run: mkdocs build

      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site

  # ────────────────────────────── Docker Build & Test ──────────────────────────────
  docker:
    needs: [test-and-build, build-cuda, build-metal]
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    permissions:
      contents: read
      packages: write
      security-events: write
    strategy:
      matrix:
        include:
          - cuda-version: "13.0.1"
            tag-suffix: ""
          - cuda-version: ""
            tag-suffix: "-cpu"
    steps:
      - uses: actions/checkout@v4

      - name: Install test dependencies
        run: pip3 install --break-system-packages -r requirements.txt

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image tags
        run: |
          REG="ghcr.io"
          OWNER="${{ github.repository_owner }}"
          if [ "${{ matrix.cuda-version }}" != "" ]; then
            NAME="hybrid-compute-gpu"
          else
            NAME="hybrid-compute-cpu"
          fi
          TAG_BASE="$REG/$OWNER/$NAME"
          echo "IMAGE_TAG1=$TAG_BASE:${{ github.sha }}" >> $GITHUB_ENV
          echo "IMAGE_TAG2=$TAG_BASE:latest${{ matrix.tag-suffix }}" >> $GITHUB_ENV

      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.cuda-version != '' && 'Dockerfile.cuda' || 'Dockerfile' }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.IMAGE_TAG1 }}
            ${{ env.IMAGE_TAG2 }}
          build-args: |
            BUILDKIT_INLINE_CACHE=1
          cache-from: type=gha
          cache-to: type=gha,mode=max
          retry: 3
          retry-delay: 10

      - name: Test container execution
        if: github.event_name != 'pull_request'
        run: |
          mkdir -p test_images
          python3 create_test_image.py
          cp test_images/test.jpg test_images/input.jpg

           GPU="${{ matrix.cuda-version != '' && 'true' || 'false' }}"
            if [ "$GPU" = "true" ]; then
              docker run --entrypoint bash "${{ env.IMAGE_TAG1 }}" \
                -c "ls -l /app/ && test -f /app/upscale && echo OK"
            else
              echo "Running CPU mode..."
                   docker run --entrypoint bash "${{ env.IMAGE_TAG1 }}" \
                     -c "ls -l /app/ && test -f /app/preprocess_c && echo OK"
            fi

      - name: Scan image with Trivy
        if: github.event_name != 'pull_request'
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          scan-ref: '${{ env.IMAGE_TAG1 }}'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        if: github.event_name != 'pull_request'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # ────────────────────────────── Dependabot Auto-Merge ──────────────────────────────
  dependabot-auto-merge:
    needs: docker
    runs-on: ubuntu-24.04
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Merge Dependabot PR
        env:
          GH_TOKEN: ${{ secrets.DEPENDABOT_MERGE_TOKEN }}
        run: gh pr merge ${{ github.event.pull_request.number }} --squash --delete-branch=false

  # ────────────────────────────── Automated Release ──────────────────────────────
  release:
    needs: docker
    runs-on: ubuntu-24.04
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Create release
        uses: googleapis/release-please-action@v4
        with:
          skip-github-pull-request: true
          token: ${{ secrets.GITHUB_TOKEN }}
